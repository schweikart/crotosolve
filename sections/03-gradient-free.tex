\chapter{Gradient-free \texttt{CRX}/\texttt{CRY}/\texttt{CRZ} optimization}
\label{chap:gradient-free}

\section{Outline}
\begin{itemize}
    \item
        Explain the concept of gradient-free optimization for the example of
        uncontrolled rorational gates (i.e., \texttt{RX}, \texttt{RY},
        \texttt{RZ}) from
        \cite{wendenius_gradient-free_2023,ostaszewski_structure_2021}.
    % \item TODO: we won't cite wendenius, criticize other paper
    %     Criticize \cite{wendenius_gradient-free_2023}'s incomplete
    %     analysis of the sinisoidal effect of rotational gate parameters on
    %     the measurement result.
    %     For example, the paper does not explain why the sinisoidal effect of
    %     rotational gate parameters also appears in circuits with more than
    %     one qubit.
    \item
        Explain how I plan to implement this for controlled rotational gates
        (i.e., \texttt{CRX}, \texttt{CRY}, \texttt{CRZ}).
    \item
        Express the effect of controlled rotational gate parameters on the
        expectation values mathematically and describe how the properties of
        this expression can be extracted from measurements.
\end{itemize}

\section{Effect}
Consider a quantum circuit -- any two-bit quantum circuit -- with a
parameterized controlled pauli rotation gate.

\begin{center}
\begin{quantikz}
\lstick{\ket{0}}    & \gate[wires=2]{U} & \ctrl{1}          & \gate[wires=2]{V}\slice[style=black]{$\ket{\varphi}$}  & \meter\qw \\
\lstick{\ket{0}}    &                   & \gate{RP(\theta)} & \qw                               & \qw
\end{quantikz}
\end{center}

If we measure the first qubit\footnote{
    This can in fact be any of the qubits.
    If we want to measure any other qubit, we can just append a corresponding
    swap gate to $V$ and the equation will remain the same.
}, we can describe the probability of measuring a $\ket 0$ by the following.

\begin{equation}
    \label{eq1}
    \begin{split}
        \mathbb{P}(M_0 = \ket 0)
            &= \mathbb{P}(M = \ket{00}) + \mathbb{P}(M = \ket{01}) \\
            &= \lvert\braket{00}{\varphi}\rvert^2 + \lvert\braket{01}{\varphi}\rvert^2
    \end{split}
\end{equation}

with $\ket{\varphi} = V \cdot CRP(\theta) \cdot U \cdot \ket{00}$.

To resolve this result, let's compute the more general
$p_{\alpha\beta} = \bra{\alpha} \cdot V \cdot CRP(\theta) \cdot U \cdot \ket{\beta}$.
% TODO: are the qubit indices correct?

\begin{equation}
    \label{eq:single-prob}
    \begin{split}
        p_{\alpha\beta}
            &= \lvert \bra\alpha \cdot V \cdot CRP(\theta) \cdot U \ket\beta \rvert^2 \\
            &= \bra\alpha \cdot V \cdot CRP(\theta) \cdot U \ket\beta
                \cdot \overline{\bra\alpha \cdot V \cdot CRP(\theta) \cdot U \ket\beta} \\
            &= \underbrace{\bra\alpha \cdot V}_{=: \bra{\tilde\alpha}} \cdot CRP(\theta)
                \cdot \underbrace{U \ket\beta \cdot \bra\beta \cdot U^\dagger}_{=: A} \cdot CRP(\theta)^\dagger
                \cdot \underbrace{V^\dagger \ket\alpha}_{=\ket{\tilde\alpha}} \\
            &= \bra{\tilde\alpha} \cdot CRP(\theta) \cdot A \cdot CRP(-\theta) \cdot \ket{\tilde\alpha} \\
            &= \bra{\tilde\alpha}
                \cdot \left(\ket 0 \bra 0 \otimes I + \ket 1 \bra 1 \otimes RP\left(\theta\right)\right) \\
                &\quad \cdot A
                \cdot \left(\ket 0 \bra 0 \otimes I + \ket 1 \bra 1 \otimes RP\left(-\theta\right)\right)
                \cdot \ket{\tilde\alpha} \\
            &= \underbrace{\bra{\tilde\alpha} \cdot (\ket 0 \bra 0 \otimes I)}_{=: \bra\gamma} \cdot A \cdot \underbrace{(\ket 0 \bra 0 \otimes I) \ket{\tilde\alpha}}_{=: \ket{\delta}} \\
                &\quad + \underbrace{\bra{\tilde\alpha} \cdot (\ket 0 \bra 0 \otimes I)}_{= \bra\gamma} \cdot A \cdot (\ket 1 \bra 1 \otimes RP\left(-\theta\right)) \ket{\tilde\alpha} \\
                &\quad + \bra{\tilde\alpha} \cdot (\ket 1 \bra 1 \otimes RP\left(\theta\right)) \cdot A \underbrace{(\ket 0 \bra 0 \otimes I) \ket{\tilde\alpha}}_{=: \ket{\delta}} \\
                &\quad + \bra{\tilde\alpha} \cdot (\ket 1 \bra 1 \otimes RP\left(\theta\right)) \cdot A \cdot (\ket 1 \bra 1 \otimes RP\left(-\theta\right)) \ket{\tilde\alpha} \\
            &= \bra\gamma \cdot A \cdot \ket\delta \\
                &\quad + \bra\gamma \cdot A \cdot (\ket 1 \bra 1 \otimes RP\left(-\theta\right)) \ket{\tilde\alpha} \\
                &\quad + \bra{\tilde\alpha} \cdot (\ket 1 \bra 1 \otimes RP\left(\theta\right)) \cdot A \ket\delta \\
                &\quad + \bra{\tilde\alpha} \cdot (\ket 1 \bra 1 \otimes RP\left(\theta\right)) \cdot A \cdot (\ket 1 \bra 1 \otimes RP\left(-\theta\right)) \ket{\tilde\alpha} \\
    \end{split}
\end{equation}

The summands in \autoref{eq:single-prob} can be further simplified using
$RP\left(\theta\right) = \cos\left(\frac\theta2\right) I - i \sin\left(\frac\theta2\right) P$
from \cite{ostaszewski_structure_2021}, the linearity of gates and by
introducing constants for parts of the equation that are independent from
$\theta$.

\begin{equation}
    \label{eq:single-prob-simplification1}
    \begin{split}
            &\quad \bra\gamma \cdot A \cdot (\ket 1 \bra 1 \otimes RP\left(-\theta\right)) \cdot \ket{\tilde\alpha} \\
            &= \bra{\gamma^\downarrow} \cdot A^\downarrow \cdot RP\left(-\theta\right) \cdot \ket{\tilde\alpha^\downarrow} \\
            &= \bra{\gamma^\downarrow} \cdot A^\downarrow \cdot \left(\cos\left(-\sfrac\theta2\right) I - i \sin\left(-\sfrac\theta2\right) P\right) \cdot \ket{\tilde\alpha^\downarrow} \\
            &= \cos\left(-\sfrac\theta2\right) \cdot \bra{\gamma^\downarrow} \cdot A^\downarrow \cdot I \cdot \ket{\tilde\alpha^\downarrow} \\
                &\quad - i \sin\left(-\sfrac\theta2\right) \cdot \bra{\gamma^\downarrow} \cdot A^\downarrow \cdot P \cdot \ket{\tilde\alpha^\downarrow} \\
            &= \cos\left(\sfrac\theta2\right) \cdot \underbrace{\bra{\gamma^\downarrow} \cdot A^\downarrow \cdot I \cdot \ket{\tilde\alpha^\downarrow}}_{=: c_1} \\
                &\quad + \sin\left(\sfrac\theta2\right) \cdot \underbrace{i \cdot \bra{\gamma^\downarrow} \cdot A^\downarrow \cdot P \cdot \ket{\tilde\alpha^\downarrow}}_{=: c_2} \\
            &= \cos\left(\sfrac\theta2\right) \cdot c_1 + \sin\left(\sfrac\theta2\right) \cdot c_2
    \end{split}
\end{equation}

\begin{equation}
    \label{eq:single-prob-simplification2}
    \begin{split}
            &\quad \bra{\tilde\alpha} \cdot (\ket 1 \bra 1 \otimes RP\left(\theta\right)) \cdot A \cdot \ket\delta \\
            &= \bra{\tilde\alpha^\downarrow} \cdot RP\left(\theta\right) \cdot A^\downarrow \cdot \ket{\delta^\downarrow} \\
            &= \bra{\tilde\alpha^\downarrow} \cdot \left(\cos\left(\sfrac\theta2\right) I - i \sin\left(\sfrac\theta2\right) P\right) \cdot A^\downarrow \cdot \ket{\delta^\downarrow} \\
            &= \cos\left(\sfrac\theta2\right) \cdot \bra{\tilde\alpha^\downarrow} \cdot I \cdot A^\downarrow \cdot \ket{\delta^\downarrow} \\
                &\quad - i \sin\left(\sfrac\theta2\right) \cdot \bra{\tilde\alpha^\downarrow} \cdot P \cdot A^\downarrow \cdot \ket{\delta^\downarrow} \\
            &= \cos\left(\sfrac\theta2\right) \cdot \underbrace{\bra{\tilde\alpha^\downarrow} \cdot I \cdot A^\downarrow \cdot \ket{\delta^\downarrow}}_{=: c_3} \\
                &\quad + \sin\left(\sfrac\theta2\right) \cdot \underbrace{\left(-i\right)\cdot \bra{\tilde\alpha^\downarrow} \cdot P \cdot A^\downarrow \cdot \ket{\delta^\downarrow}}_{=: c_4} \\
            &= \cos\left(\sfrac\theta2\right) \cdot c_3 + \sin\left(\sfrac\theta2\right) \cdot c_4
    \end{split}
\end{equation}

\begin{equation}
    \label{eq:single-prob-simplification3}
    \begin{split}
            &\quad \bra{\tilde\alpha} \cdot (\ket 1 \bra 1 \otimes RP\left(\theta\right)) \cdot A \cdot (\ket 1 \bra 1 \otimes RP\left(-\theta\right)) \cdot \ket{\tilde\alpha} \\
            &= \bra{\tilde\alpha^\downarrow} \cdot RP\left(\theta\right) \cdot A^\downarrow \cdot RP\left(-\theta\right) \cdot \ket{\tilde\alpha^\downarrow} \\
            &= \bra{\tilde\alpha^\downarrow} \cdot \left(\cos\left(\sfrac\theta2\right) I - i \sin\left(\sfrac\theta2\right) P\right) \\
                &\quad\cdot A^\downarrow \cdot \left(\cos\left(-\sfrac\theta2\right) I - i \sin\left(-\sfrac\theta2\right) P\right) \cdot \ket{\tilde\alpha^\downarrow} \\
            &= \cos\left(\sfrac\theta2\right)\cos\left(-\sfrac\theta2\right) \bra{\tilde\alpha} \cdot I \cdot A \cdot I \cdot \ket{\tilde\alpha^\downarrow} \\
                &\quad + \cos\left(\sfrac\theta2\right)\sin\left(-\sfrac\theta2\right) \cdot (-i) \cdot \bra{\tilde\alpha} \cdot I \cdot A \cdot P \cdot \ket{\tilde\alpha^\downarrow}  \\
                &\quad + \sin\left(\sfrac\theta2\right)\cos\left(-\sfrac\theta2\right) \cdot (-i) \cdot \bra{\tilde\alpha} \cdot P \cdot A \cdot I \cdot \ket{\tilde\alpha^\downarrow} \\
                &\quad + \sin\left(\sfrac\theta2\right)\sin\left(-\sfrac\theta2\right) \cdot (-i)^2 \cdot \bra{\tilde\alpha} \cdot P \cdot A \cdot P \cdot \ket{\tilde\alpha^\downarrow} \\
            &= \cos\left(\sfrac\theta2\right)^2 \cdot \underbrace{\bra{\tilde\alpha} \cdot A \cdot \ket{\tilde\alpha^\downarrow}}_{=: c_5} \\
                &\quad + \cos\left(\sfrac\theta2\right)\sin\left(\sfrac\theta2\right) \cdot \underbrace{i \cdot \bra{\tilde\alpha} \cdot A \cdot P \cdot \ket{\tilde\alpha^\downarrow}}_{=: c_6} \\
                &\quad + \sin\left(\sfrac\theta2\right)\cos\left(\sfrac\theta2\right) \cdot \underbrace{(-i) \cdot \bra{\tilde\alpha} \cdot P \cdot A \cdot \ket{\tilde\alpha^\downarrow}}_{=: c_7} \\
                &\quad + \sin\left(\sfrac\theta2\right)^2 \cdot \underbrace{\bra{\tilde\alpha} \cdot P \cdot A \cdot P \cdot \ket{\tilde\alpha^\downarrow}}_{=: c_8} \\
            &= \cos\left(\sfrac\theta2\right)^2 \cdot c_5 + \sin\left(\sfrac\theta2\right)^2 \cdot c_8 \\
                &\quad + \cos\left(\sfrac\theta2\right)\sin\left(\sfrac\theta2\right) \cdot \left(c_6 + c_7\right)
    \end{split}
\end{equation}

With \ref{eq:single-prob-simplification1},
\ref{eq:single-prob-simplification2} and \ref{eq:single-prob-simplification3},
equation \ref{eq:single-prob} can be expressed as the following.

\begin{equation}
    \label{eq:single-prob-simplified}
    \begin{split}
        p_{\alpha\beta}
            &\stackrel{(\ref{eq:single-prob})}= \underbrace{\bra\gamma \cdot A \cdot \ket\delta}_{=: c_9} \\
                &\quad + \bra\gamma \cdot A \cdot (\ket 1 \bra 1 \otimes RP\left(-\theta\right)) \ket{\tilde\alpha} \\
                &\quad + \bra{\tilde\alpha} \cdot (\ket 1 \bra 1 \otimes RP\left(\theta\right)) \cdot A \ket\delta \\
                &\quad + \bra{\tilde\alpha} \cdot (\ket 1 \bra 1 \otimes RP\left(\theta\right)) \cdot A \cdot (\ket 1 \bra 1 \otimes RP\left(-\theta\right)) \ket{\tilde\alpha} \\
            &\stackrel{\substack{(\ref{eq:single-prob-simplification1})\\(\ref{eq:single-prob-simplification2})\\(\ref{eq:single-prob-simplification3})}}=
                c_9 \\
                &\quad + \cos\left(\sfrac\theta2\right) \cdot c_1 + \sin\left(\sfrac\theta2\right) \cdot c_2 \\
                &\quad + \cos\left(\sfrac\theta2\right) \cdot c_3 + \sin\left(\sfrac\theta2\right) \cdot c_4 \\
                &\quad + \cos\left(\sfrac\theta2\right)^2 \cdot c_5 + \sin\left(\sfrac\theta2\right)^2 \cdot c_8 \\
                &\quad + \cos\left(\sfrac\theta2\right)\sin\left(\sfrac\theta2\right) \cdot \left(c_6 + c_7\right) \\
            &= c_9 \\
                &\quad + \cos\left(\sfrac\theta2\right) \cdot \left(c_1 + c_3\right) + \sin\left(\sfrac\theta2\right) \cdot \left(c_2 + c_4\right) \\
                &\quad + \cos\left(\sfrac\theta2\right)^2 \cdot c_5 + \sin\left(\sfrac\theta2\right)^2 \cdot c_8 \\
                &\quad + \cos\left(\sfrac\theta2\right)\sin\left(\sfrac\theta2\right) \cdot \left(c_6 + c_7\right) \\
    \end{split}
\end{equation}

This equation in turn can be simplified even further through the use of the
following trigonometric identities:

\begin{equation}
    \begin{split}
        \cos^2\left(\theta\right) &= \frac12 + \frac12 \cos\left(2\theta\right) \\
        \sin^2\left(\theta\right) &= \frac12 - \frac12 \cos\left(2\theta\right) \\
        \cos\left(\theta\right)\sin\left(\varphi\right) &= \frac12\sin\left(\theta + \varphi\right) + \frac12 \sin\left(\theta - \varphi\right) \\
        a\cos x + b \sin x &= sgn(a) \sqrt{a^2 + b^2} \cos\left(x + \arctan\left(-\frac ba\right)\right)
    \end{split}
\end{equation}

\begin{equation}
    \label{eq:single-prob-simplified-simplified}
    \begin{split}
        p_{\alpha\beta}
            &\stackrel{(\ref{eq:single-prob-simplified})}= c_9 \\
                &\quad + \cos\left(\sfrac\theta2\right) \cdot \left(c_1 + c_3\right) + \sin\left(\sfrac\theta2\right) \cdot \left(c_2 + c_4\right) \\
                &\quad + \cos\left(\sfrac\theta2\right)^2 \cdot c_5 + \sin\left(\sfrac\theta2\right)^2 \cdot c_8 \\
                &\quad + \cos\left(\sfrac\theta2\right)\sin\left(\sfrac\theta2\right) \cdot \left(c_6 + c_7\right) \\
            &= c_9 \\
                &\quad + \cos\left(\sfrac\theta2\right) \cdot \left(c_1 + c_3\right) + \sin\left(\sfrac\theta2\right) \cdot \left(c_2 + c_4\right) \\
                &\quad + \left(\frac12 + \frac12 \cos\left(\theta\right)\right) \cdot c_5 + \left(\frac12 - \frac12 \cos\left(\theta\right)\right) \cdot c_8 \\
                &\quad + \frac12 \sin\left(\underline{\frac\theta2 + \frac\theta2}_{=\theta}\right) + \underbrace{\frac12 \sin\left(\frac\theta2 - \frac\theta2\right)}_{= 0} \\
            &= c_9 + \frac{c_5}{2} + \frac{c_8}{2} \\
                &\quad + \cos\left(\sfrac\theta2\right) \cdot \left(c_1 + c_3\right) + \sin\left(\sfrac\theta2\right) \cdot \left(c_2 + c_4\right) \\
                &\quad + \cos\left(\theta\right) \cdot \left(\frac{c_5}{2} - \frac{c_8}{2}\right) + \sin\left(\theta\right) \cdot \frac12 \\
            &= \underbrace{c_9 + \frac{c_5}{2} + \frac{c_8}{2}}_{=: d_1} \\
                &\quad + \cos\left(\sfrac\theta2 + \underbrace{\arctan\left(-\frac{c_2 + c_4}{c_1 + c_3}\right)}_{=: d_2}\right) \cdot \underbrace{sgn\left(c_1 + c_3\right) \sqrt{(c_1 + c_3)^2 + (c_2 + c_4)^2}}_{=: d_3} \\
                &\quad + \cos\left(\theta + \underbrace{\arctan\left(-\frac{\frac12}{\frac{c_5}{2} - \frac{c_6}{2}}\right)}_{=: d_4}\right) \cdot \underbrace{sgn\left(\frac{c_5}{2} - \frac{c_6}{2}\right) \sqrt{\left(\frac{c_5}{2} - \frac{c_6}{2}\right)^2 + \left(\frac12\right)^2}}_{=: d_5} \\
            &= d_1 + \cos\left(\sfrac\theta2 + d_2\right) \cdot d_3 + \cos\left(\theta + d_4\right) \cdot d_5
    \end{split}
\end{equation}

\section{Determining the constants}
Equation \ref{eq:single-prob-simplified-simplified} describes the effect of the
rotation angle parameter on the expectation value of a single qubit.
The simple structure of this formula comes at the cost of five unknown
constants $d_1, \dots, d_5$.
While it is possible to compute those constants from their definitions in
equations \ref{eq:single-prob} - \ref{eq:single-prob-simplified-simplified},
this computation is as computationally expensive as simulating the execution of
the quantum circuit.
% TODO: add a reason for this. something about calculating <alpha|A|beta>

Instead, because of the sinoidal nature of the function, the constants can be
determined through a few evaluations of the quantum circuit.

\begin{equation}
    \label{eq:y}
    \begin{split}
        y(\theta)
            &= d_1 + \underbrace{d_3 \cos(\sfrac\theta2 + d_2)}_{=: y_1(\theta)} + \underbrace{d_5 \cos(\theta + d_4)}_{=: y_2(\theta)}\\
            &= d_1 + y_1(\theta) + y_2(\theta)
    \end{split}
\end{equation}

We can analyze $y_1$ and $y_2$ separately by constructing interferences of $y$
with a phase-shifted version of itself.
Note that
$\cos(\varphi + \pi) = -\cos(\varphi), \cos(\varphi + 2\pi) = \cos(\varphi)$.

\begin{equation}
    \label{eq:d1+y2}
    \begin{split}
        y(\theta) + y(\theta + 2\pi)
            &= d_1 + d_3 \cos(\sfrac\theta2 + d_2) + d_5 \cos(\theta + d_4)\\
                &\quad + d_1 + d_3 \cos(\sfrac\theta2 + d_2 + \pi) + d_5 \cos(\theta + d_4 + 2\pi)\\
            &= d_1 + d_3 \cos(\sfrac\theta2 + d_2) + d_5 \cos(\theta + d_4)\\
                &\quad + d_1 - d_3 \cos(\sfrac\theta2 + d_2) + d_5 \cos(\theta + d_4)\\
            &= 2 d_1 + 2 d_5 \cos(\theta + d_4)\\
            &= 2 d_1 + 2 y_2(\theta)\\
        \Rightarrow y_2(\theta) &= \frac12 (y(\theta) + y(\theta + 2\pi) - 2 d_1)
    \end{split}
\end{equation}

Again, the interference of this function with itself can be used to eliminate
$y_2$.

\begin{equation}
    \label{eq:d1}
    \begin{split}
        &\quad y(\theta) + y(\theta + \pi) + y(\theta + 2\pi) + y(\theta + 3\pi)\\
            &= y(\theta) + y(\theta + 2\pi) + y(\theta + \pi) + y((\theta + \pi) + 2\pi)\\
            &\stackrel{\ref{eq:d1+y2}}= 2d_1 + 2d_5\cos(\theta + d_4) + 2d_1 + 2d_5\cos(\theta + \pi + d_4)\\
            &= 2d_1 + 2d_5\cos(\theta + d_4) + 2d_1 - 2d_5\cos(\theta + d_4)\\
            &= 4d_1\\
        \Rightarrow d_1 &= \frac14(y(\theta) + y(\theta + \pi) + y(\theta + 2\pi) + y(\theta + 3\pi))
    \end{split}
\end{equation}

With $d_1$, we can now work with $y_2$ to determine $d_4$ and $_5$.
To do so, we first need to catch an edge case.
If $d_5 = 0$, then $y_2(\theta)$ is $0$ for all angles $\theta$ and $d_4$ can be
chosen arbitrarily.
Since $\sin$ and $\cos$ have distinct zeros, we can check for this condition
with two evaluations $y_2(\theta)$ and $y_2(\theta + \sfrac32\pi)$.

\begin{equation}
    \label{eq:d5-0}
    d_5 = 0 \quad\Leftrightarrow\quad\bigwedge
    \begin{cases}
        0 = d_5 \cos(\theta + d_4) = y_2(\theta) \\
        0 = d_5 \sin(\theta + d_4) = \cos(\theta + d_4 + \sfrac32\pi) = y_2(\theta + \sfrac32\pi)
    \end{cases}
\end{equation}

If $y_2(\theta) = 0$ and $y_2(\theta + \sfrac32\pi) \neq 0$, we can derive
$d_4$ and $d_5$ as follows.
Note that we restrict the zeros of $\cos$ to be $\sfrac12\pi$ or $\sfrac32\pi$
without loss of generality since $\cos$ is $2\pi$-periodic.
We can further eliminate $\sfrac32\pi$ since choosing $\sfrac32\pi$ over
$\sfrac12\pi$ only changes the sign of the function, which can also be chosen
through its amplitude $d_5$.

\begin{equation}
    \label{eq:whateverman}
    \begin{split}
        0 &= y_2(\theta) = d_5 \cos(\theta + d_4) \\
        &\stackrel{d_5 \neq 0}\Rightarrow\quad \theta + d_4 = \sfrac12\pi\\
        &\Rightarrow\quad d_4 =\sfrac12\pi - \theta
    \end{split}
\end{equation}

The corresponding amplitude can then be computed as

\begin{equation}
    \label{eq:whateverman2}
    \begin{split}
        y_2(\theta + \sfrac32\pi)
            &= d_5 \cos(\theta + d_4 + \sfrac32\pi)\\
            &= d_5 \cos(\sfrac12\pi + \sfrac32\pi)\\
            &= d_5 \cos(2\pi)\\
            &= d_5\,.
    \end{split}
\end{equation}

If $y_2(\theta) \neq 0$, we can use the inverse of the $\tan$ function to
compute $d_4$.

\begin{equation}
    \label{eq:d4}
    \begin{split}
        \frac{y_2(\theta + \sfrac32 \pi)}{y_2(\theta)}
            &= \frac{d_5 \cos(\theta + \sfrac32 \pi + d_4)}{d_5 \cos(\theta + d_4)} \\
            &= \frac{\sin(\theta + d_4)}{\cos(\theta + d_4)} \\
            &= \tan(\theta + d_4) \\
        \Rightarrow \theta + d_4
            &= \arctan\left(\frac{y_2(\theta + \sfrac32 \pi)}{y_2(\theta)}\right) \\
        \Rightarrow d_4
            &= \arctan\left(\frac{y_2(\theta + \sfrac32 \pi)}{y_2(\theta)}\right) - \theta
            % TODO reduce to y
    \end{split}
\end{equation}

The computation of $d_5$ then needs no additional circuit evaluations.

\begin{equation}
    \label{eq:d5}
    \begin{split}
        y_2(\theta)
            &= d_5 \cos(\theta + d_4) \\
        \Rightarrow d_5
            &= \frac{y_2(\theta)}{\cos(\theta + d_4)}
            % TODO reduce to y
        % TODO: is this safe? could divide by zero but we have lots of thetas to choose from!
    \end{split}
\end{equation}

A similar approach can be used to determine the remaining constants, $d_2$ and
$d_3$.
Again, we use an interference of $y$ with a phase-shifted version of itself to
find an equation with only the missing constants.

\begin{equation}
    \label{eq:y1}
    \begin{split}
        y(\theta) - y(\theta + 2\pi)
            &= d_1 + d_3 \cos(\sfrac\theta2 + d_2) + d_5 \cos(\theta + d_4)\\
                &\quad - d_1 - d_3 \cos(\sfrac\theta2 + \pi + d_2) - d_5 \cos(\theta + 2\pi + d_4)\\
            &= d_1 + d_3 \cos(\sfrac\theta2 + d_2) + d_5 \cos(\theta + d_4)\\
                &\quad - d_1 + d_3 \cos(\sfrac\theta2 + d_2) - d_5 \cos(\theta + d_4)\\
            &= 2 d_3 \cos(\sfrac\theta2 + d_2)\\
            &= 2 y_1(\theta)\\
        \Rightarrow y_1(\theta) &= \frac12\left(y(\theta) - y(\theta + 2\pi)\right)
    \end{split}
\end{equation}

And, again similary to \ref{eq:d1+y2} to \ref{eq:d4}, the missing constants can
be derived from this equation.
First, we handle the case where $y_1$ zeroes out and $d_2$ can be chosen
arbitrarily.

\begin{equation}
    \label{eq:d3-0}
    d_3 = 0 \quad\Leftrightarrow\quad \bigwedge
    \begin{cases}
        0 = d_3 \cos(\sfrac\theta2 + d_2) = y_1(\theta) \\
        0 = d_3 \sin(\sfrac\theta2 + d_2) = d_3 \cos(\sfrac\theta2 + d_2 + \sfrac32\pi) = y_1(\theta + 3\pi)
    \end{cases}
\end{equation}

Second, if $y_1(\theta) = 0$ but $y_1(\theta + 3\pi) \neq 0$, $d_4$ and $d_5$ can
be determined by choosing $\sfrac\theta2 + d_2$ as a zero point of $\cos$.

\begin{equation}
    \label{eq:whateverman-the-second}
    \begin{split}
        0 = y_1(\theta) &= d_3 \cos(\sfrac\theta2 + d_2)\\
        \stackrel{d_3 \neq 0}\Rightarrow \sfrac12\pi &= \sfrac\theta2 + d_2\\
        \Rightarrow \sfrac12\pi - \sfrac\theta2 &= d_2
    \end{split}
\end{equation}

\begin{equation}
    \label{eq:whateverman2-the-second}
    \begin{split}
        y_1(\theta + 3\pi)
            &= d_3 \cos(\sfrac\theta2 + d_2 + \sfrac32\pi)\\
            &= d_3 \cos(\sfrac12\pi + \sfrac32\pi)\\
            &= d_3 \cos(2\pi)\\
            &= d_3
    \end{split}
\end{equation}

And third, we can determine $d_2$ and $d_3$ with the use of $\tan$'s inverse if
$y_1(\theta) \neq 0$.

\begin{equation}
    \label{eq:d2}
    \begin{split}
        \frac{y_1(\theta + 3\pi)}{y_1(\theta)}
            &= \frac{d_3 \cos(\sfrac\theta2 + \sfrac32 \pi + d_2)}{d_3 \cos(\sfrac\theta2 + d_2)} \\
            &= \frac{\sin(\sfrac\theta2 + d_2)}{\cos(\sfrac\theta2 + d_2)} \\
            &= \tan(\sfrac\theta2 + d_2) \\
        \Rightarrow \sfrac\theta2 + d_2
            &= \arctan\left(\frac{y_1(\theta + 3\pi)}{y_1(\theta)}\right) \\
        \Rightarrow d_2
            &= \arctan\left(\frac{y_1(\theta + 3\pi)}{y_1(\theta)}\right) - \sfrac\theta2
            % TODO resolve for y
    \end{split}
\end{equation}

\begin{equation}
    \label{eq:d3}
    \begin{split}
        y_1(\theta)
            &= d_3 \cos(\sfrac\theta2 + d_2) \\
        \Rightarrow d_3
            &= \frac{y_1(\theta)}{\cos(\sfrac\theta2 + d_2)}
            % TODO: resolve for y
    \end{split}
\end{equation}

Therefore, the constants $d_1, \dots, d_5$ can be determined with a total of six
quantum circuit evaluations
$y(\theta), y(\theta + \pi), y(\theta + \sfrac32\pi), y(\theta + 2\pi), y(\theta + 3\pi)$
and $y(\theta + \sfrac72\pi)$.
For convenience, they are summarized in the following.

\begin{subequations}
    \label{eq:constants}
    \begin{align}
        d_1 &= \frac14 (y(\theta) + y(\theta + 2\pi) + y(\theta + \pi) + y(\theta + 3\pi))
            \label{eq:constants-d1}\\
        d_4 &= \arctan\left(\frac{y(\theta + \sfrac32 \pi) + y(\theta + \sfrac72 \pi) - 2 d_1}{y(\theta) + y(\theta + 2\pi) - 2 d_1}\right) - \theta
            \label{eq:constants-d4}\\
        d_5 &= \frac{y(\theta) + y(\theta + 2\pi) - 2 d_1}{2 \cos(\theta + d_4)}
            \label{eq:constants-d5}\\
        d_2 &= \arctan\left(\frac{y(\theta + 3\pi) - y(\theta + \pi)}{y(\theta) - y(\theta - 2\pi)}\right) - \sfrac\theta2
            \label{eq:constants-d2}\\
        d_3 &= \frac{y(\theta) - y(\theta - 2\pi)}{2 \cos(\sfrac\theta2 + d_2)}
            \label{eq:constants-d3}
            %TODO reorder
    \end{align}
\end{subequations}
