\chapter{Gradient-free \texttt{CRX}/\texttt{CRY}/\texttt{CRZ} optimization}
\label{chap:gradient-free}

\section{Outline}
\begin{itemize}
    \item
        Explain the concept of gradient-free optimization for the example of
        uncontrolled rorational gates (i.e., \texttt{RX}, \texttt{RY},
        \texttt{RZ}) from
        \cite{wendenius_gradient-free_2023,ostaszewski_structure_2021}.
    % \item TODO: we won't cite wendenius, criticize other paper
    %     Criticize \cite{wendenius_gradient-free_2023}'s incomplete
    %     analysis of the sinisoidal effect of rotational gate parameters on
    %     the measurement result.
    %     For example, the paper does not explain why the sinisoidal effect of
    %     rotational gate parameters also appears in circuits with more than
    %     one qubit.
    \item
        Explain how I plan to implement this for controlled rotational gates
        (i.e., \texttt{CRX}, \texttt{CRY}, \texttt{CRZ}).
    \item
        Express the effect of controlled rotational gate parameters on the
        expectation values mathematically and describe how the properties of
        this expression can be extracted from measurements.
\end{itemize}

\section{Effect}
Consider a quantum circuit -- any two-bit quantum circuit -- with a
parameterized controlled pauli rotation gate.

\begin{center}
\begin{quantikz}
\lstick{\ket{0}}    & \gate[wires=2]{U} & \ctrl{1}          & \gate[wires=2]{V}\slice[style=black]{$\ket{\varphi}$}  & \meter\qw \\
\lstick{\ket{0}}    &                   & \gate{RP(\theta)} & \qw                               & \qw
\end{quantikz}
\end{center}

If we measure the first qubit\footnote{
    This can in fact be any of the qubits.
    If we want to measure any other qubit, we can just append a corresponding
    swap gate to $V$ and the equation will remain the same.
}, we can describe the probability of measuring a $\ket 0$ by the following.

\begin{equation}
    \label{eq1}
    \begin{split}
        \mathbb{P}(M_0 = \ket 0)
            &= \mathbb{P}(M = \ket{00}) + \mathbb{P}(M = \ket{01}) \\
            &= \lvert\braket{00}{\varphi}\rvert^2 + \lvert\braket{01}{\varphi}\rvert^2
    \end{split}
\end{equation}

with $\ket{\varphi} = V \cdot CRP(\theta) \cdot U \cdot \ket{00}$.

To resolve this result, let's compute the more general
$p_{\alpha\beta} = \bra{\alpha} \cdot V \cdot CRP(\theta) \cdot U \cdot \ket{\beta}$.
% TODO: are the qubit indices correct?

\begin{equation}
    \label{eq:single-prob}
    \begin{split}
        p_{\alpha\beta}
            &= \lvert \bra\alpha \cdot V \cdot CPR(\theta) \cdot U \ket\beta \rvert^2 \\
            &= \bra\alpha \cdot V \cdot CPR(\theta) \cdot U \ket\beta
                \cdot \overline{\bra\alpha \cdot V \cdot CPR(\theta) \cdot U \ket\beta} \\
            &= \underbrace{\bra\alpha \cdot V}_{=: \bra{\tilde\alpha}} \cdot CPR(\theta)
                \cdot \underbrace{U \ket\beta \cdot \bra\beta \cdot U^\dagger}_{=: A} \cdot CPR(\theta)^\dagger
                \cdot \underbrace{V^\dagger \ket\alpha}_{=\ket{\tilde\alpha}} \\
            &= \bra{\tilde\alpha} \cdot CPR(\theta) \cdot A \cdot CPR(-\theta) \cdot \ket{\tilde\alpha} \\
            &= \bra{\tilde\alpha}
                \cdot \left(\ket 0 \bra 0 \otimes I + \ket 1 \bra 1 \otimes RP\left(\theta\right)\right) \\
                &\quad \cdot A
                \cdot \left(\ket 0 \bra 0 \otimes I + \ket 1 \bra 1 \otimes RP\left(-\theta\right)\right)
                \cdot \ket{\tilde\alpha} \\
            &= \underbrace{\bra{\tilde\alpha} \cdot (\ket 0 \bra 0 \otimes I)}_{=: \bra\gamma} \cdot A \cdot \underbrace{(\ket 0 \bra 0 \otimes I) \ket{\tilde\alpha}}_{=: \ket{\delta}} \\
                &\quad + \underbrace{\bra{\tilde\alpha} \cdot (\ket 0 \bra 0 \otimes I)}_{= \bra\gamma} \cdot A \cdot (\ket 1 \bra 1 \otimes RP\left(-\theta\right)) \ket{\tilde\alpha} \\
                &\quad + \bra{\tilde\alpha} \cdot (\ket 1 \bra 1 \otimes RP\left(\theta\right)) \cdot A \underbrace{(\ket 0 \bra 0 \otimes I) \ket{\tilde\alpha}}_{=: \ket{\delta}} \\
                &\quad + \bra{\tilde\alpha} \cdot (\ket 1 \bra 1 \otimes RP\left(\theta\right)) \cdot A \cdot (\ket 1 \bra 1 \otimes RP\left(-\theta\right)) \ket{\tilde\alpha} \\
            &= \bra\gamma \cdot A \cdot \ket\delta \\
                &\quad + \bra\gamma \cdot A \cdot (\ket 1 \bra 1 \otimes RP\left(-\theta\right)) \ket{\tilde\alpha} \\
                &\quad + \bra{\tilde\alpha} \cdot (\ket 1 \bra 1 \otimes RP\left(\theta\right)) \cdot A \ket\delta \\
                &\quad + \bra{\tilde\alpha} \cdot (\ket 1 \bra 1 \otimes RP\left(\theta\right)) \cdot A \cdot (\ket 1 \bra 1 \otimes RP\left(-\theta\right)) \ket{\tilde\alpha} \\
    \end{split}
\end{equation}

The summands in \autoref{eq:single-prob} can be further simplified using
$RP\left(\theta\right) = \cos\left(\frac\theta2\right) I - i \sin\left(\frac\theta2\right) P$
from \cite{ostaszewski_structure_2021}, the linearity of gates and by
introducing constants for parts of the equation that are independent from
$\theta$.

\begin{equation}
    \label{eq:single-prob-simplification1}
    \begin{split}
            &\quad \bra\gamma \cdot A \cdot (\ket 1 \bra 1 \otimes RP\left(-\theta\right)) \cdot \ket{\tilde\alpha} \\
            &= \bra{\gamma^\downarrow} \cdot A^\downarrow \cdot RP\left(-\theta\right) \cdot \ket{\tilde\alpha^\downarrow} \\
            &= \bra{\gamma^\downarrow} \cdot A^\downarrow \cdot \left(\cos\left(-\sfrac\theta2\right) I - i \sin\left(-\sfrac\theta2\right) P\right) \cdot \ket{\tilde\alpha^\downarrow} \\
            &= \cos\left(-\sfrac\theta2\right) \cdot \bra{\gamma^\downarrow} \cdot A^\downarrow \cdot I \cdot \ket{\tilde\alpha^\downarrow} \\
                &\quad - i \sin\left(-\sfrac\theta2\right) \cdot \bra{\gamma^\downarrow} \cdot A^\downarrow \cdot P \cdot \ket{\tilde\alpha^\downarrow} \\
            &= \cos\left(\sfrac\theta2\right) \cdot \underbrace{\bra{\gamma^\downarrow} \cdot A^\downarrow \cdot I \cdot \ket{\tilde\alpha^\downarrow}}_{=: c_1} \\
                &\quad + \sin\left(\sfrac\theta2\right) \cdot \underbrace{i \cdot \bra{\gamma^\downarrow} \cdot A^\downarrow \cdot P \cdot \ket{\tilde\alpha^\downarrow}}_{=: c_2} \\
            &= \cos\left(\sfrac\theta2\right) \cdot c_1 + \sin\left(\sfrac\theta2\right) \cdot c_2
    \end{split}
\end{equation}

\begin{equation}
    \label{eq:single-prob-simplification2}
    \begin{split}
            &\quad \bra{\tilde\alpha} \cdot (\ket 1 \bra 1 \otimes RP\left(\theta\right)) \cdot A \cdot \ket\delta \\
            &= \bra{\tilde\alpha^\downarrow} \cdot RP\left(\theta\right) \cdot A^\downarrow \cdot \ket{\delta^\downarrow} \\
            &= \bra{\tilde\alpha^\downarrow} \cdot \left(\cos\left(\sfrac\theta2\right) I - i \sin\left(\sfrac\theta2\right) P\right) \cdot A^\downarrow \cdot \ket{\delta^\downarrow} \\
            &= \cos\left(\sfrac\theta2\right) \cdot \bra{\tilde\alpha^\downarrow} \cdot I \cdot A^\downarrow \cdot \ket{\delta^\downarrow} \\
                &\quad - i \sin\left(\sfrac\theta2\right) \cdot \bra{\tilde\alpha^\downarrow} \cdot P \cdot A^\downarrow \cdot \ket{\delta^\downarrow} \\
            &= \cos\left(\sfrac\theta2\right) \cdot \underbrace{\bra{\tilde\alpha^\downarrow} \cdot I \cdot A^\downarrow \cdot \ket{\delta^\downarrow}}_{=: c_3} \\
                &\quad + \sin\left(\sfrac\theta2\right) \cdot \underbrace{\left(-i\right)\cdot \bra{\tilde\alpha^\downarrow} \cdot P \cdot A^\downarrow \cdot \ket{\delta^\downarrow}}_{=: c_4} \\
            &= \cos\left(\sfrac\theta2\right) \cdot c_3 + \sin\left(\sfrac\theta2\right) \cdot c_4
    \end{split}
\end{equation}

\begin{equation}
    \label{eq:single-prob-simplification3}
    \begin{split}
            &\quad \bra{\tilde\alpha} \cdot (\ket 1 \bra 1 \otimes RP\left(\theta\right)) \cdot A \cdot (\ket 1 \bra 1 \otimes RP\left(-\theta\right)) \cdot \ket{\tilde\alpha} \\
            &= \bra{\tilde\alpha^\downarrow} \cdot RP\left(\theta\right) \cdot A^\downarrow \cdot RP\left(-\theta\right) \cdot \ket{\tilde\alpha^\downarrow} \\
            &= \bra{\tilde\alpha^\downarrow} \cdot \left(\cos\left(\sfrac\theta2\right) I - i \sin\left(\sfrac\theta2\right) P\right) \\
                &\quad\cdot A^\downarrow \cdot \left(\cos\left(-\sfrac\theta2\right) I - i \sin\left(-\sfrac\theta2\right) P\right) \cdot \ket{\tilde\alpha^\downarrow} \\
            &= \cos\left(\sfrac\theta2\right)\cos\left(-\sfrac\theta2\right) \bra{\tilde\alpha} \cdot I \cdot A \cdot I \cdot \ket{\tilde\alpha^\downarrow} \\
                &\quad + \cos\left(\sfrac\theta2\right)\sin\left(-\sfrac\theta2\right) \cdot (-i) \cdot \bra{\tilde\alpha} \cdot I \cdot A \cdot P \cdot \ket{\tilde\alpha^\downarrow}  \\
                &\quad + \sin\left(\sfrac\theta2\right)\cos\left(-\sfrac\theta2\right) \cdot (-i) \cdot \bra{\tilde\alpha} \cdot P \cdot A \cdot I \cdot \ket{\tilde\alpha^\downarrow} \\
                &\quad + \sin\left(\sfrac\theta2\right)\sin\left(-\sfrac\theta2\right) \cdot (-i)^2 \cdot \bra{\tilde\alpha} \cdot P \cdot A \cdot P \cdot \ket{\tilde\alpha^\downarrow} \\
            &= \cos\left(\sfrac\theta2\right)^2 \cdot \underbrace{\bra{\tilde\alpha} \cdot A \cdot \ket{\tilde\alpha^\downarrow}}_{=: c_5} \\
                &\quad + \cos\left(\sfrac\theta2\right)\sin\left(\sfrac\theta2\right) \cdot \underbrace{i \cdot \bra{\tilde\alpha} \cdot A \cdot P \cdot \ket{\tilde\alpha^\downarrow}}_{=: c_6} \\
                &\quad + \sin\left(\sfrac\theta2\right)\cos\left(\sfrac\theta2\right) \cdot \underbrace{(-i) \cdot \bra{\tilde\alpha} \cdot P \cdot A \cdot \ket{\tilde\alpha^\downarrow}}_{=: c_7} \\
                &\quad + \sin\left(\sfrac\theta2\right)^2 \cdot \underbrace{\bra{\tilde\alpha} \cdot P \cdot A \cdot P \cdot \ket{\tilde\alpha^\downarrow}}_{=: c_8} \\
            &= \cos\left(\sfrac\theta2\right)^2 \cdot c_5 + \sin\left(\sfrac\theta2\right)^2 \cdot c_8 \\
                &\quad + \cos\left(\sfrac\theta2\right)\sin\left(\sfrac\theta2\right) \cdot \left(c_6 + c_7\right)
    \end{split}
\end{equation}

With \ref{eq:single-prob-simplification1},
\ref{eq:single-prob-simplification2} and \ref{eq:single-prob-simplification3},
equation \ref{eq:single-prob} can be expressed as the following.

\begin{equation}
    \label{eq:single-prob-simplified}
    \begin{split}
        p_{\alpha\beta}
            &\stackrel{(\ref{eq:single-prob})}= \underbrace{\bra\gamma \cdot A \cdot \ket\delta}_{=: c_9} \\
                &\quad + \bra\gamma \cdot A \cdot (\ket 1 \bra 1 \otimes RP\left(-\theta\right)) \ket{\tilde\alpha} \\
                &\quad + \bra{\tilde\alpha} \cdot (\ket 1 \bra 1 \otimes RP\left(\theta\right)) \cdot A \ket\delta \\
                &\quad + \bra{\tilde\alpha} \cdot (\ket 1 \bra 1 \otimes RP\left(\theta\right)) \cdot A \cdot (\ket 1 \bra 1 \otimes RP\left(-\theta\right)) \ket{\tilde\alpha} \\
            &\stackrel{\substack{(\ref{eq:single-prob-simplification1})\\(\ref{eq:single-prob-simplification2})\\(\ref{eq:single-prob-simplification3})}}=
                c_9 \\
                &\quad + \cos\left(\sfrac\theta2\right) \cdot c_1 + \sin\left(\sfrac\theta2\right) \cdot c_2 \\
                &\quad + \cos\left(\sfrac\theta2\right) \cdot c_3 + \sin\left(\sfrac\theta2\right) \cdot c_4 \\
                &\quad + \cos\left(\sfrac\theta2\right)^2 \cdot c_5 + \sin\left(\sfrac\theta2\right)^2 \cdot c_8 \\
                &\quad + \cos\left(\sfrac\theta2\right)\sin\left(\sfrac\theta2\right) \cdot \left(c_6 + c_7\right) \\
            &= c_9 \\
                &\quad + \cos\left(\sfrac\theta2\right) \cdot \left(c_1 + c_3\right) + \sin\left(\sfrac\theta2\right) \cdot \left(c_2 + c_4\right) \\
                &\quad + \cos\left(\sfrac\theta2\right)^2 \cdot c_5 + \sin\left(\sfrac\theta2\right)^2 \cdot c_8 \\
                &\quad + \cos\left(\sfrac\theta2\right)\sin\left(\sfrac\theta2\right) \cdot \left(c_6 + c_7\right) \\
    \end{split}
\end{equation}

This equation in turn can be simplified even further through the use of the
following trigonometric identities:

\begin{equation}
    \begin{split}
        \cos^2\left(\theta\right) &= \frac12 + \frac12 \cos\left(2\theta\right) \\
        \sin^2\left(\theta\right) &= \frac12 - \frac12 \cos\left(2\theta\right) \\
        \cos\left(\theta\right)\sin\left(\varphi\right) &= \frac12\sin\left(\theta + \varphi\right) + \frac12 \sin\left(\theta - \varphi\right) \\
        a\cos x + b \sin x &= sgn(a) \sqrt{a^2 + b^2} \cos\left(x + \arctan\left(-\frac ba\right)\right)
    \end{split}
\end{equation}

\begin{equation}
    \label{eq:single-prob-simplified-simplified}
    \begin{split}
        p_{\alpha\beta}
            &\stackrel{(\ref{eq:single-prob-simplified})}= c_9 \\
                &\quad + \cos\left(\sfrac\theta2\right) \cdot \left(c_1 + c_3\right) + \sin\left(\sfrac\theta2\right) \cdot \left(c_2 + c_4\right) \\
                &\quad + \cos\left(\sfrac\theta2\right)^2 \cdot c_5 + \sin\left(\sfrac\theta2\right)^2 \cdot c_8 \\
                &\quad + \cos\left(\sfrac\theta2\right)\sin\left(\sfrac\theta2\right) \cdot \left(c_6 + c_7\right) \\
            &= c_9 \\
                &\quad + \cos\left(\sfrac\theta2\right) \cdot \left(c_1 + c_3\right) + \sin\left(\sfrac\theta2\right) \cdot \left(c_2 + c_4\right) \\
                &\quad + \left(\frac12 + \frac12 \cos\left(\theta\right)\right) \cdot c_5 + \left(\frac12 - \frac12 \cos\left(\theta\right)\right) \cdot c_8 \\
                &\quad + \frac12 \sin\left(\underline{\frac\theta2 + \frac\theta2}_{=\theta}\right) + \underbrace{\frac12 \sin\left(\frac\theta2 - \frac\theta2\right)}_{= 0} \\
            &= c_9 + \frac{c_5}{2} + \frac{c_8}{2} \\
                &\quad + \cos\left(\sfrac\theta2\right) \cdot \left(c_1 + c_3\right) + \sin\left(\sfrac\theta2\right) \cdot \left(c_2 + c_4\right) \\
                &\quad + \cos\left(\theta\right) \cdot \left(\frac{c_5}{2} - \frac{c_8}{2}\right) + \sin\left(\theta\right) \cdot \frac12 \\
            &= \underbrace{c_9 + \frac{c_5}{2} + \frac{c_8}{2}}_{=: d_1} \\
                &\quad + \cos\left(\sfrac\theta2 + \underbrace{\arctan\left(-\frac{c_2 + c_4}{c_1 + c_3}\right)}_{=: d_2}\right) \cdot \underbrace{sgn\left(c_1 + c_3\right) \sqrt{(c_1 + c_3)^2 + (c_2 + c_4)^2}}_{=: d_3} \\
                &\quad + \cos\left(\theta + \underbrace{\arctan\left(-\frac{\frac12}{\frac{c_5}{2} - \frac{c_6}{2}}\right)}_{=: d_4}\right) \cdot \underbrace{sgn\left(\frac{c_5}{2} - \frac{c_6}{2}\right) \sqrt{\left(\frac{c_5}{2} - \frac{c_6}{2}\right)^2 + \left(\frac12\right)^2}}_{=: d_5} \\
            &= d_1 + \cos\left(\sfrac\theta2 + d_2\right) \cdot d_3 + \cos\left(\theta + d_4\right) \cdot d_5
    \end{split}
\end{equation}